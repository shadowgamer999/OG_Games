<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shadow Runner - Ultimate Version</title>
    <style>
        body { margin: 0; background: #87CEEB; overflow: hidden; font-family: 'Segoe UI', Tahoma, sans-serif; touch-action: none; }
        
        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #mainMenu, #gameOver { 
            position: absolute; width: 100%; height: 100%; 
            background: linear-gradient(#1e3c72, #2a5298); 
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; z-index: 100; color: white; text-align: center;
        }

        h1 { font-size: 8vw; max-size: 60px; margin-bottom: 10px; text-shadow: 3px 3px #000; }

        .menu-btn { 
            width: 80%; max-width: 250px; padding: 15px; margin: 10px; 
            background: #ffcc00; border: none; font-size: 18px; font-weight: bold; 
            border-radius: 30px; cursor: pointer; box-shadow: 0 4px #ccaa00; 
            transition: 0.2s; 
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }

        .volume-container { margin: 15px; padding: 10px 20px; background: rgba(0,0,0,0.3); border-radius: 20px; width: fit-content; }
        input[type=range] { accent-color: #ffcc00; cursor: pointer; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø°Ù‡Ø¨ */
        #coinScore { position: absolute; top: 15px; right: 20px; color: #ffd700; font-size: 28px; font-weight: bold; text-shadow: 2px 2px #000; z-index: 10; pointer-events: none; }
        
        /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        #distScore { 
            position: absolute; top: 15px; left: 20px; 
            color: #00ffff; font-size: 28px; font-weight: bold; 
            text-shadow: 2px 2px #000; z-index: 10; pointer-events: none;
            background: rgba(0, 0, 0, 0.4); padding: 5px 15px; border-radius: 15px;
            border: 2px solid #00ffff;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .controls { position: absolute; bottom: 5%; width: 100%; display: flex; justify-content: center; gap: 15px; z-index: 20; }
        .btn { 
            width: 65px; height: 65px; background: rgba(255,255,255,0.2); 
            border: 2px solid #fff; border-radius: 50%; display: flex; 
            justify-content: center; align-items: center; font-size: 24px; 
            color: white; cursor: pointer; user-select: none; backdrop-filter: blur(5px);
        }
        .btn:active { background: rgba(255,255,255,0.5); }

        #infoModal { 
            display: none; position: absolute; width: 85%; max-width: 400px; 
            background: white; color: #333; padding: 20px; border-radius: 20px; 
            text-align: center; z-index: 110; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }

        #mobileHint { position: absolute; bottom: 20%; width: 100%; text-align: center; color: rgba(255,255,255,0.6); font-size: 14px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="mainMenu">
        <h1>SHADOW RUNNER</h1>
        <div class="lang-container" style="margin-bottom:10px;">
            <select id="langSelect" onchange="changeLanguage(this.value)" style="padding: 8px; border-radius: 8px;">
                <option value="en">English</option>
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="es">EspaÃ±ol</option>
            </select>
        </div>
        <button class="menu-btn" id="startBtn" onclick="startGame()">Start Adventure</button>
        <button class="menu-btn" id="infoBtn" style="background: #00ffff; box-shadow: 0 4px #00cccc;" onclick="showInfo()">How to Play</button>
        <div class="volume-container">
            <span id="volText">ğŸ”Š Volume: </span>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5" oninput="updateVolume()">
        </div>
    </div>

    <div id="infoModal">
        <h2 id="infoTitle">Game Info</h2>
        <p><strong id="ownerLabel">Owner:</strong> Shadow</p>
        <p id="gameDesc">Swipe to move. Jump over cars, slide under barriers!</p>
        <button class="menu-btn" id="closeInfoBtn" style="width: 100px;" onclick="closeInfo()">Got it!</button>
    </div>

    <div id="gameOver" style="display:none;">
        <h1 id="overTitle">Game Over!</h1>
        <h2 id="finalCoins">ğŸ’° 0</h2>
        <h3 id="finalDist" style="margin-top:0; color:#00ffff;">ğŸƒ 0m</h3>
        <button class="menu-btn" id="restartBtn" onclick="location.reload()">Play Again</button>
    </div>

    <div id="coinScore">ğŸ’° 0</div>
    <div id="distScore">ğŸƒ 0m</div>
    <div id="mobileHint">Swipe or use buttons</div>
    
    <div class="controls" id="gameControls" style="display:none;">
        <div class="btn" onmousedown="move(-1)" ontouchstart="move(-1)">â¬…ï¸</div>
        <div class="btn" onmousedown="slide()" ontouchstart="slide()">â¬‡ï¸</div>
        <div class="btn" onmousedown="jump()" ontouchstart="jump()">â¬†ï¸</div>
        <div class="btn" onmousedown="move(1)" ontouchstart="move(1)">â¡ï¸</div>
    </div>

    <audio id="bgMusic" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3"></audio>
    <audio id="coinSound" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø© ---
        const translations = {
            en: { start: "Start Adventure", about: "How to Play", volume: "ğŸ”Š Volume: ", infoTitle: "Game Info", owner: "Owner: ", desc: "Swipe to move. Jump over cars, slide under barriers!", gotIt: "Got it!", over: "Game Over!", playAgain: "Play Again", hint: "Swipe or use buttons", dir: "ltr" },
            ar: { start: "Ø¥Ø¨Ø¯Ø£ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©", about: "ÙƒÙŠÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨", volume: "ğŸ”Š Ø§Ù„ØµÙˆØª: ", infoTitle: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", owner: "Ø§Ù„Ù…Ø·ÙˆØ±: ", desc: "Ø§Ù‚ÙØ² ÙÙˆÙ‚ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙˆØªØ²Ø­Ù„Ù‚ ØªØ­Øª Ø§Ù„Ø­ÙˆØ§Ø¬Ø²!", gotIt: "ÙÙ‡Ù…Øª!", over: "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!", playAgain: "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©", hint: "Ø§Ø³Ø­Ø¨ Ù„Ù„Ø´Ø§Ø´Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø±", dir: "rtl" },
            es: { start: "Empezar", about: "CÃ³mo jugar", volume: "ğŸ”Š Volumen: ", infoTitle: "Info", owner: "DueÃ±o: ", desc: "Â¡Salta los coches, deslÃ­zate bajo las barreras!", gotIt: "Â¡Vale!", over: "Â¡Fin del juego!", playAgain: "Jugar de nuevo", hint: "Desliza o usa botones", dir: "ltr" }
        };

        function changeLanguage(lang) {
            const t = translations[lang];
            document.documentElement.dir = t.dir;
            document.getElementById('startBtn').innerText = t.start;
            document.getElementById('infoBtn').innerText = t.about;
            document.getElementById('volText').innerText = t.volume;
            document.getElementById('infoTitle').innerText = t.infoTitle;
            document.getElementById('ownerLabel').innerText = t.owner;
            document.getElementById('gameDesc').innerText = t.desc;
            document.getElementById('closeInfoBtn').innerText = t.gotIt;
            document.getElementById('overTitle').innerText = t.over;
            document.getElementById('restartBtn').innerText = t.playAgain;
            document.getElementById('mobileHint').innerText = t.hint;
        }

        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let scene, camera, renderer, player, clock;
        let obstacles = [], coins = [], decor = [], roadLines = [];
        let score = 0, distance = 0, gameActive = false, speed = 0.5, playerLane = 0;
        let isJumping = false, jumpV = 0;
        let isSliding = false, slideTimer = 0;
        
        const music = document.getElementById('bgMusic');
        const coinSnd = document.getElementById('coinSound');

        // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 6, 11);
            camera.lookAt(0, 2, -5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(20, 50, 20);
            sun.castShadow = true;
            scene.add(sun);

            // Ø§Ù„Ø·Ø±ÙŠÙ‚
            const road = new THREE.Mesh(new THREE.PlaneGeometry(24, 1000), new THREE.MeshPhongMaterial({ color: 0x333333 }));
            road.rotation.x = -Math.PI / 2;
            road.receiveShadow = true;
            scene.add(road);

            // Ø®Ø·ÙˆØ· Ø§Ù„Ø·Ø±ÙŠÙ‚ (Ù„Ù„Ø²ÙŠÙ†Ø©)
            createRoadMarkings();

            // Ø§Ù„Ù„Ø§Ø¹Ø¨
            player = new THREE.Mesh(new THREE.BoxGeometry(1.5, 3, 1.5), new THREE.MeshPhongMaterial({ color: 0xff0000 }));
            player.position.set(0, 1.5, 5);
            player.castShadow = true;
            scene.add(player);
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ù…Ø­ ÙˆØ¬Ù‡ Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø§Ø¹Ø¨
            const face = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1, 0.5), new THREE.MeshBasicMaterial({ color: 0xffdbac }));
            face.position.set(0, 0.5, 0.6);
            player.add(face);

            clock = new THREE.Clock();
            
            // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¨Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
            for(let i=0; i<15; i++) spawnDecor(i * -25);

            // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ­ÙƒÙ…
            window.addEventListener('resize', onWindowResize, false);
            window.addEventListener('keydown', handleKey);
            setupTouchControls();
            
            updateVolume();
            changeLanguage('en');
        }

        function createRoadMarkings() {
            const lineGeo = new THREE.PlaneGeometry(0.5, 5);
            const lineMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            
            // Ø®Ø·ÙˆØ· Ù„Ù„Ù…Ø³Ø§Ø±ÙŠÙ† Ø§Ù„ÙØ§ØµÙ„ÙŠÙ†
            for(let i=0; i<40; i++) {
                let l1 = new THREE.Mesh(lineGeo, lineMat);
                l1.rotation.x = -Math.PI / 2;
                l1.position.set(-3.5, 0.02, 10 - (i * 10));
                
                let l2 = new THREE.Mesh(lineGeo, lineMat);
                l2.rotation.x = -Math.PI / 2;
                l2.position.set(3.5, 0.02, 10 - (i * 10));

                scene.add(l1, l2);
                roadLines.push(l1, l2);
            }
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨ ---
        function animate() {
            if (!gameActive) return;
            requestAnimationFrame(animate);
            let delta = clock.getDelta();

            // 1. Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ù‚ÙØ² ÙˆØ§Ù†Ø²Ù„Ø§Ù‚)
            if (isJumping) {
                player.position.y += jumpV;
                jumpV -= 0.025; // Ø¬Ø§Ø°Ø¨ÙŠØ©
                if (player.position.y <= 1.5) { 
                    player.position.y = 1.5; 
                    isJumping = false; 
                }
            } else if (isSliding) {
                slideTimer -= delta;
                if (slideTimer <= 0) {
                    isSliding = false;
                    player.scale.set(1, 1, 1); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø¬Ù… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
                    player.position.y = 1.5;
                }
            } else {
                // ØªØ£Ø«ÙŠØ± Ø¬Ø±ÙŠ Ø¨Ø³ÙŠØ·
                player.position.y = 1.5 + Math.sin(clock.getElapsedTime() * 15) * 0.1;
            }

            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø³Ù„Ø³ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
            player.position.x = THREE.MathUtils.lerp(player.position.x, playerLane, 0.15);

            // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙˆØ§Ø¦Ù‚ ÙˆØ§Ù„Ø°Ù‡Ø¨
            if (Math.random() < 0.02) spawnObstacle();
            if (Math.random() < 0.05) spawnCoin();

            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù‚Ø¨Ø§Øª
            obstacles.forEach((obj, i) => {
                obj.position.z += speed;

                // ÙƒØ´Ù Ø§Ù„ØªØµØ§Ø¯Ù…
                // Ø§Ù„Ù…Ø³Ø§ÙØ© Z Ù‚Ø±ÙŠØ¨Ø© + Ø§Ù„Ù…Ø³Ø§ÙØ© X Ù‚Ø±ÙŠØ¨Ø© (Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø±)
                if (Math.abs(obj.position.z - player.position.z) < 2.5 && Math.abs(obj.position.x - player.position.x) < 2) {
                    
                    if (obj.userData.type === 'slide') {
                        // Ø¹Ù‚Ø¨Ø© Ø§Ù†Ø²Ù„Ø§Ù‚: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙŠØªØ²Ø­Ù„Ù‚ -> Ø®Ø³Ø§Ø±Ø©
                        if (!isSliding) endGame();
                    } 
                    else if (obj.userData.type === 'truck') {
                        // Ø´Ø§Ø­Ù†Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠÙ‚ÙØ² ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ ØºÙŠØ± ÙƒØ§ÙÙ (Ø§Ù„Ø´Ø§Ø­Ù†Ø© Ø·ÙˆÙŠÙ„Ø©) -> Ø®Ø³Ø§Ø±Ø©
                        // Ø§Ù„Ø´Ø§Ø­Ù†Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù‚ÙØ² ÙÙˆÙ‚Ù‡Ø§
                        endGame();
                    }
                    else {
                        // Ø³ÙŠØ§Ø±Ø© Ø¹Ø§Ø¯ÙŠØ©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ -> Ø®Ø³Ø§Ø±Ø© (Ø§Ù„Ù‚ÙØ² ÙŠÙ†Ø¬ÙŠÙƒ)
                        if (player.position.y < 2.5) endGame();
                    }
                }

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                if (obj.position.z > 20) { scene.remove(obj); obstacles.splice(i, 1); }
            });

            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø°Ù‡Ø¨
            coins.forEach((coin, i) => {
                coin.position.z += speed;
                coin.rotation.y += 0.05;
                // Ø¬Ù…Ø¹ Ø§Ù„Ø°Ù‡Ø¨
                if (Math.abs(coin.position.z - player.position.z) < 2 && Math.abs(coin.position.x - player.position.x) < 2) {
                    scene.remove(coin); coins.splice(i, 1);
                    score += 10;
                    document.getElementById('coinScore').innerText = "ğŸ’° " + score;
                    
                    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù…Ù†Ø®ÙØ¶)
                    const s = coinSnd.cloneNode();
                    s.volume = coinSnd.volume;
                    s.play();
                }
                if (coin.position.z > 20) { scene.remove(coin); coins.splice(i, 1); }
            });

            // ØªØ­Ø±ÙŠÙƒ Ø®Ø·ÙˆØ· Ø§Ù„Ø·Ø±ÙŠÙ‚ ÙˆØ§Ù„Ù…Ø¨Ø§Ù†ÙŠ (Loop)
            roadLines.forEach(line => {
                line.position.z += speed;
                if(line.position.z > 20) line.position.z -= 200; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø®Ø·ÙˆØ·
            });

            decor.forEach(obj => {
                obj.position.z += speed;
                if(obj.position.z > 20) {
                    obj.position.z = -300;
                    obj.position.x = (Math.random() > 0.5 ? 20 : -20); // ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
                }
            });

            // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ù…Ø³Ø§ÙØ©
            speed += 0.0001;
            distance += speed * 0.5;
            document.getElementById('distScore').innerText = "ğŸƒ " + Math.floor(distance) + "m";

            renderer.render(scene, camera);
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ---
        function spawnObstacle() {
            if(obstacles.length > 5) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¯Ø³
            const lane = [-7, 0, 7][Math.floor(Math.random()*3)];
            const typeRand = Math.random();
            let mesh, type;

            if (typeRand < 0.3) {
                // Ø´Ø§Ø­Ù†Ø© (Ø·ÙˆÙŠÙ„Ø© - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù‚ÙØ² ÙÙˆÙ‚Ù‡Ø§)
                mesh = new THREE.Mesh(new THREE.BoxGeometry(5, 7, 10), new THREE.MeshPhongMaterial({ color: 0x3333aa })); // Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ†
                mesh.position.set(lane, 3.5, -150);
                type = 'truck';
            } else if (typeRand < 0.6) {
                // Ø­Ø§Ø¬Ø² (Ù…Ø±ØªÙØ¹ - ÙŠØ¬Ø¨ Ø§Ù„ØªØ²Ø­Ù„Ù‚ ØªØ­ØªÙ‡)
                mesh = new THREE.Mesh(new THREE.BoxGeometry(6, 1, 1), new THREE.MeshPhongMaterial({ color: 0xffaa00 })); // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
                mesh.position.set(lane, 4, -150); // Ù…Ø±ØªÙØ¹ Ø¹Ù† Ø§Ù„Ø£Ø±Ø¶
                
                // Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø­Ø§Ø¬Ø²
                const pole1 = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 4), new THREE.MeshPhongMaterial({color:0x888888}));
                pole1.position.set(-2.5, -2, 0);
                const pole2 = pole1.clone();
                pole2.position.set(2.5, -2, 0);
                mesh.add(pole1, pole2);
                
                type = 'slide';
            } else {
                // Ø³ÙŠØ§Ø±Ø© (ÙŠÙ…ÙƒÙ† Ø§Ù„Ù‚ÙØ² ÙÙˆÙ‚Ù‡Ø§)
                mesh = new THREE.Mesh(new THREE.BoxGeometry(4, 2.5, 6), new THREE.MeshPhongMaterial({ color: 0xff4444 })); // Ø£Ø­Ù…Ø±
                mesh.position.set(lane, 1.25, -150);
                type = 'car';
            }
            
            mesh.castShadow = true;
            mesh.userData.type = type;
            scene.add(mesh);
            obstacles.push(mesh);
        }

        function spawnCoin() {
            const coin = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 0.2, 16), new THREE.MeshPhongMaterial({ color: 0xffd700 }));
            coin.rotation.x = Math.PI/2;
            const lane = [-7, 0, 7][Math.floor(Math.random()*3)];
            
            // Ø±ÙØ¹ Ø§Ù„Ø°Ù‡Ø¨ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‚ÙØ²Ø©
            coin.position.set(lane, 2, -150 - Math.random()*10);
            scene.add(coin);
            coins.push(coin);
        }

        function spawnDecor(zPos) {
            const h = 10 + Math.random() * 30;
            const geo = new THREE.BoxGeometry(8, h, 8);
            const mat = new THREE.MeshPhongMaterial({ color: Math.random() * 0xffffff });
            const b = new THREE.Mesh(geo, mat);
            b.position.set((Math.random() > 0.5 ? 22 : -22), h/2, zPos);
            scene.add(b);
            decor.push(b);
        }

        // --- Ø§Ù„ØªØ­ÙƒÙ… ---
        function move(dir) { 
            if (dir === -1 && playerLane > -7) playerLane -= 7; 
            if (dir === 1 && playerLane < 7) playerLane += 7; 
        }

        function jump() { 
            if (!isJumping && !isSliding) { 
                isJumping = true; 
                jumpV = 0.6; // Ù‚ÙˆØ© Ø§Ù„Ù‚ÙØ²
            } 
        }

        function slide() {
            if (!isJumping && !isSliding) {
                isSliding = true;
                slideTimer = 0.8; // Ù…Ø¯Ø© Ø§Ù„Ø§Ù†Ø²Ù„Ø§Ù‚ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
                player.scale.set(1.2, 0.5, 1.2); // ØªÙ‚Ù„ÙŠØµ Ø§Ù„Ø­Ø¬Ù… (ØªØ³Ø·ÙŠØ­)
                player.position.y = 0.75; // Ø®ÙØ¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹
            }
        }

        function handleKey(e) {
            if (!gameActive) return;
            if (e.key === "ArrowLeft" || e.key === "a") move(-1);
            if (e.key === "ArrowRight" || e.key === "d") move(1);
            if (e.key === "ArrowUp" || e.key === "w" || e.key === " ") jump();
            if (e.key === "ArrowDown" || e.key === "s") slide();
        }

        function setupTouchControls() {
            let touchStartX = 0;
            let touchStartY = 0;
            document.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, {passive: false});

            document.addEventListener('touchend', e => {
                if(!gameActive) return;
                let dx = e.changedTouches[0].screenX - touchStartX;
                let dy = e.changedTouches[0].screenY - touchStartY;
                
                if(Math.abs(dx) > Math.abs(dy)) {
                    if(Math.abs(dx) > 30) move(dx > 0 ? 1 : -1);
                } else {
                    if(Math.abs(dy) > 30) {
                        if(dy > 0) slide(); // Ø³Ø­Ø¨ Ù„Ù„Ø£Ø³ÙÙ„
                        else jump(); // Ø³Ø­Ø¨ Ù„Ù„Ø£Ø¹Ù„Ù‰
                    }
                }
            }, {passive: false});
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        function updateVolume() {
            const vol = document.getElementById('volumeSlider').value;
            music.volume = vol;
            coinSnd.volume = vol * 0.4; // ØµÙˆØª Ù‡Ø§Ø¯Ø¦
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function startGame() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameControls').style.display = 'flex';
            document.getElementById('mobileHint').style.display = 'block';
            gameActive = true;
            music.play();
            animate();
        }

        function showInfo() { document.getElementById('infoModal').style.display = 'block'; }
        function closeInfo() { document.getElementById('infoModal').style.display = 'none'; }
        
        function endGame() { 
            gameActive = false; 
            music.pause(); 
            document.getElementById('gameOver').style.display = 'flex'; 
            document.getElementById('gameControls').style.display = 'none';
            document.getElementById('mobileHint').style.display = 'none';
            document.getElementById('finalCoins').innerText = "ğŸ’° " + score; 
            document.getElementById('finalDist').innerText = "ğŸƒ " + Math.floor(distance) + "m";
        }

        init();
    </script>
</body>
</html>